---
title: "Decision analysis"
author: "digital ECMT"
date: "01/07/2021"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE, results=F} 
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
##NOTE: the following packages are required to run this script, but should be installed (e.g. using code snippets below) before runnning the script, NOT as part of the script itself

# options(repos = "http://cran.us.r-project.org")
# install.packages("BiocManager")
# BiocManager::install("AnnotationDbi")
# BiocManager::install("org.Hs.eg.db")
# BiocManager::install("KEGGREST")
# BiocManager::install("KEGGlincs")
# BiocManager::install("hgu133a.db")
require(KEGGlincs)
require(KEGGgraph)

require(RPostgreSQL)
require(RODBC)
require(formattable)
require(org.Hs.eg.db)
require(DBI)
require(dplyr)
require(tidyr)
require(kableExtra)
require(KEGGREST)
require(stringr)
#require(stringi)
require(splitstackshape)
require(reshape2)
require(tictoc)
require(maps)
require(leaflet)
require(PostcodesioR)
require(rjson)
require(RSQLite)
require(igraph)

## clean up first
rm(list=ls())

##get today's date
today <- format(Sys.Date(), format = "%d %B %Y")



```

**Date of data refresh: `r today`**  
  
### **Objective**  
  
Decision analysis for clinical decision "*Which genomic features should I use to match patients to clinical trials?*"  
  
Where possible options are combinations of: *match on inclusion criteria*, *match on drug target*, *match on pathway*, or match on cancer type alone.  
  
### **Approach**  
  
Retrieve studies with results from clinicaltrials.gov.  
Index on cancer type.  
Index on genetic inclusion criteria.  
Index on intevention target.  
Index on intervention pathway.  
  
Get outcome results for (each arm of) each study.  
  
Take a set of patients (e.g. prior patients who had a meeting outcome of "clinical trial recommended").  
   
   
#### **1. Retrieve studies with results from clinicaltrials.gov**  
  
  
```{r connect to clinicaltrialsgov}  
## specify user name and password for AACT account
## see https://aact.ctti-clinicaltrials.org/ for how to create an account

## load configuration data from JSON file
configuration <- fromJSON(file = "trialMatchConfiguration.json")
aact.username <- configuration$aact.username
aact.password <- configuration$aact.password

drv <- dbDriver("PostgreSQL")
conn2 <- dbConnect(drv, dbname="aact",host="aact-db.ctti-clinicaltrials.org", port=5432, user=aact.username, password=aact.password )
```
 
```{r get studies with results}

## get interventional studies 
## any indication
## any location
## with results

# form query
studiesResultsQ <- "SELECT s.nct_id, s.brief_title, s.overall_status, c.name AS condition, s.number_of_arms, s.number_of_groups, i.name AS interventions, cv.were_results_reported
FROM studies s
INNER JOIN conditions c ON c.nct_id = s.nct_id
INNER JOIN interventions i ON i.nct_id = s.nct_id
inner join calculated_values cv on cv.nct_id = s.nct_id
WHERE s.study_type LIKE ('Interventional')
  AND s.overall_status IN ('Completed')
  and cv.were_results_reported = 'true'"


## get data from clinicaltrials.gov
studiesResults <- dbGetQuery(conn2,studiesResultsQ)

## add a column to indicate refresh date
studiesResults$Refresh.date <- today


```

Number of studies with results (any indication): `r length(unique(studiesResults$nct_id))`  
  
  
```{r create table of cancer types}
## conditionSynonyms specifies which cancer types are of interest, and which condition names (as used by clinicaltrials.gov) will be considered as matches for each

## synonyms define on basis of those in clinicaltrials.gov
conditionSynonyms <- read.csv(file = "conditionSynonyms5.csv", stringsAsFactors = FALSE)

## trim leading/trailing whitespace
conditionSynonyms$condition.synonyms <- str_squish(string = conditionSynonyms$condition.synonyms)

## remove redundancy, if any
conditionSynonyms <- unique(conditionSynonyms)

```
   

```{r loop through synonyms and look for matches against condition name}
## add a column to hold matching condition
studiesResults$matching.condition <- NA
studiesResults$TARGET.condition <- NA

## create an empty version to which matching rows will be added after looping through condition synonyms
cancerStudies <- studiesResults[0, ]

# loop through condition synonyms
for(i in 1:nrow(conditionSynonyms)) {
  synonym <- as.character(conditionSynonyms$condition.synonyms[i])
  targetCondition <- as.character(conditionSynonyms$controlled.cancer.type[i])
  ## look for a match in condition name
  matching.rows <- grep(pattern = synonym, x=studiesResults$condition, ignore.case = TRUE)
  ## create a temporary data frame to hold matches
  temp <- studiesResults[matching.rows, ]
  if(nrow(temp)>0) {
    temp$matching.condition <- synonym
  temp$TARGET.condition <- targetCondition
  cancerStudies <- rbind(cancerStudies, temp)
  }
}

## overwrite openStudies with openStudies2
#openStudies <- openStudies2
## delete copy of openStudies to save memory
rm(studiesResults)

## remove redundant rows, if any
cancerStudies <- unique(cancerStudies)


## get eligibility criteria (before connection times out)
studyIDs <- unique(cancerStudies$nct_id)

## form SQL query
studyIDsForSQL <- paste0("\'",paste(studyIDs, collapse = "\',\'"), "\'")
getEligibilities <- paste0("select e.nct_id, e.criteria 
from eligibilities e
where e.nct_id in (",
"", studyIDsForSQL,
")")

## get criteria from clinicaltrials.gov
eligibilities <- dbGetQuery(conn2,getEligibilities)
```
  

Number of studies with results (solid cancer studies only): `r length(unique(cancerStudies$nct_id))`  


    